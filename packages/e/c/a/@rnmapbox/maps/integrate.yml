steps:
  - task: prompt
    actions:
      - name: platform
        text: "Select platforms to integrate:"
        type: multiselect
        options:
          - value: android
          - value: ios
        required: true

      - name: android_key
        when:
          platform: android
        text: "Enter Mapbox Downloads Token for Android"
        type: text

      - name: location
        type: boolean
        text: Planning to display the user's location on the map or get the user's location information?
      - name: precise
        when:
          platform: android
          location: true
        type: boolean
        text: Precise location?

      - when:
          location: true
        text: Enter location usage description to be added to Info.plist as NSLocationWhenInUseUsageDescription
        name: location_usage_description
        type: text
        defaultValue: $(PRODUCT_NAME) needs access to your location.
        placeholder: $(PRODUCT_NAME) needs access to your location.

  - task: prompt
    when:
      platform: ios
    actions:
      - name: ios_key
        text: "Enter Mapbox Downloads Token for Ios"
        type: text
    postInfo:
      title: Verify .netrc
      message: |
        Make sure your .netrc is configured with your secret access token, as described by the mapbox docs. To verify execute:
        
            grep -A 4 api.mapbox.com ~/.netrc
        
        This should output something like:
        
            machine api.mapbox.com
              login mapbox
              password $[ios_key]

  - task: podfile
    when:
      platform: ios
    label: Adding code in Podfile
    actions:
      - block: target.pre_install
        append: $RNMapboxMaps.pre_install(installer)
      - block: target.post_install
        append: $RNMapboxMaps.post_install(installer)

  - task: gradle_properties
    label: Adding token to gradle properties
    when:
      platform: android
    actions:
      - ifNotPresent: MAPBOX_DOWNLOADS_TOKEN
        append: |
          MAPBOX_DOWNLOADS_TOKEN=$[android_key]

  - task: build_gradle
    location: root
    label: Adding code to build.gradle
    when:
      platform: android
    actions:
      - block: buildscript.ext
        append: RNMapboxMapsImpl = "mapbox"
      - block: allprojects.repositories
        append: |-2
          maven {
            url 'https://api.mapbox.com/downloads/v2/releases/maven'
            authentication {
                basic(BasicAuthentication)
            }
            credentials {
                // Do not change the username below.
                // This should always be `mapbox` (not your username).
                username = 'mapbox'
                // Use the secret token you stored in gradle.properties as the password
                password = project.properties['MAPBOX_DOWNLOADS_TOKEN'] ?: ""
            }
          }

  - task: android_manifest
    when:
      platform: android
      location: true
    label: Updating android manifest
    actions:
      - append: <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
        before: <application
      - when:
          precise: true
        append: <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
        before: <application

  - task: plist
    label: Updating Info.plist
    when:
      platform: ios
      location: true
    actions:
      - set:
          NSLocationWhenInUseUsageDescription: $[location_usage_description]
